esphome:
  name: test1
  friendly_name: door

esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "FgOdCu4a85uwmmQuxaRUF9Qf2Pegq/VZj37Nze/xqfk="

ota:
  - platform: esphome
    password: "e646a4e7683b0b69f7df6c6dbe5bf388"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "Test1 Fallback Hotspot"
    password: "hE4qkdtxNrRb"

captive_portal:
binary_sensor:
  - platform: gpio
    pin: GPIO18
    name: "Nút nhấn"
    id: button_input
    on_press:
      then:
        - logger.log: "Button nhấn - kích hoạt buzzer"
        - output.turn_on: buzzer
        - delay: 1000ms
        - output.turn_off: buzzer

output:
  - platform: gpio
    pin: GPIO15
    id: buzzer

  - platform: ledc
    id: pwm_output
    pin: GPIO17
    frequency: 50 Hz

script:
  - id: open_servo
    then:
      - servo.write:
          id: door_servo
          level: 100.0%
  - id: close_servo
    then:
      - servo.write:
          id: door_servo
          level: -100.0%

servo:
  - id: door_servo
    output: pwm_output
    auto_detach_time: 5s
    transition_length: 0s

spi:
  clk_pin: GPIO14
  mosi_pin: GPIO13
  miso_pin: GPIO12

rc522_spi:
  cs_pin: GPIO5
  update_interval: 1s
  on_tag:
    then:
      - lambda: |-
          std::string tag = x;
          ESP_LOGI("rc522", "Thẻ đọc được: %s", tag.c_str());
      - if:
          condition:
            lambda: 'return x == "91-05-4A-01";'
          then:
            - logger.log: "Thẻ đúng - mở khóa"
            - script.execute: open_servo
            - delay: 3000ms
            - script.execute: close_servo
          else:
            - logger.log: "Thẻ sai - kích hoạt buzzer"
            - output.turn_on: buzzer
            - delay: 500ms
            - output.turn_off: buzzer

# === (Tuỳ chọn) Thêm nút ảo và slider trên Home Assistant ===
button:
  - platform: template
    name: "Mở cửa"
    icon: "mdi:lock-open"
    on_press:
      then:
        - script.execute: open_servo
  - platform: template
    name: "Đóng cửa"
    icon: "mdi:lock"
    on_press:
      then:
        - script.execute: close_servo
  - platform: template
    name: "Kích hoạt Buzzer"
    icon: "mdi:volume-high"
    on_press:
      then:
        - logger.log: "Nút ảo nhấn - Buzzer bật"
        - output.turn_on: buzzer
        - delay: 1s
        - output.turn_off: buzzer

number:
  - platform: template
    name: "Servo Door Position"
    optimistic: true
    min_value: -100
    max_value: 100
    step: 1
    set_action:
      then:
        - servo.write:
            id: door_servo
            level: !lambda 'return x / 100.0;'
